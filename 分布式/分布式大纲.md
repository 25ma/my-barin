#分布式 

# 分布式大纲

- 分布式幂等性如何设计？
	- 针对数据字段做唯一索引
	- 使用 token 机制，提交时获取 token，操作完成删除 token。使用 token 要注意并发问题，防止 token 的 select 与 delete 出现并发问题。
	- 使用悲观锁，可用数据库锁或分布式锁实现。
	- 使用乐观锁，如版本号机制。
	- 状态机幂等，仅合法状态变更才可继续。
- 一次 HTTP 请求经历的步骤
	1. 通过 DNS 协议将域名解析成 IP，如果该域名有 CDN 的话，则返回 CDN 地址。
		- 无 CDN 的情况
			1. 首先从浏览器缓存中加载。
			2. 浏览器缓存没有查看本地 host 文件。
			3. 本地 host 文件没有查找根域名服务器。
			4. 根域名服务器没有再转发到顶级域名服务器，递归查询直到找到对应的 IP 地址。
		- 有 CDN 的情况
			1. CDN 第一步也会进行 DNS 解析，不过解析返回的不是 IP 地址而是 cname 加速域名。
			2. CDN 根据负载情况返回一个实际请求的 IP 地址。
	2. 判断浏览器是否存在缓存，若存在缓存直接使用缓存数据，否则进行请求查询
		- 强缓存：根据 expires 和 cache-control 控制判断。
		- 协商缓存：如 last-modified 头到服务器进行缓存对比。
	3. 开始进行 HTTP 请求，进行三次握手与四次回收协议
	4. TCP 连接建立完毕，发送请求获得数据
		1. TCP 到底网络层，进行 IP 包组装。通过 OSPF 协议进行路由转发，ARP 协议进行 IP 地址与 MAC 地址的映射。
		2. IP层数据到达数据链路层，将数据转化为01信号交给物理层传输。
	5. 浏览器得到数据，进行渲染响应
- 分布式事务
	- CAP 定理：在一个分布式系统中，最多实现以下两点，不能三点兼顾
		- Consistency 一致性。
		- Availability 可用性。
		- Partition-Tolerance 分区容错性。
	- BASE理论
- 负载均衡算法
	- 轮询
	- 加权轮询
	- 随机
	- 最少连接
	- 原地址 hash
- 限流算法
	- 计数器算法：设定一个阈值，每次访问时计数器+1，达到阈值限流，每周期清空。存在临界访问压力大的问题，周期结束与下一个周期开始期间可能出现两倍的请求量。这违背了限流的原则。
	- 滑动窗口算法：将时间周期分为更小的周期，总周期内访问阈值固定。滑动窗口清除过期的小周期。窗口拆分的越小，滑动越平稳，限流统计越准确。
	- 漏桶算法
		- 请求到达时放入漏桶，超过阈值则丢弃。漏桶以固定速率释放请求，直到漏桶为空。
		- 漏桶算法重视总量控制，最高请求是多少。
		- **漏桶尽可能的缓冲请求，只有缓冲不了才丢弃**。适合突发场景的流量大问题，如整点秒杀，签到等。
	- 令牌桶算法
		- 以 r 的速率向令牌桶中增加令牌，直到桶满。请求从令牌中获取令牌，超过则限流。
		- 令牌桶算法重视速率控制，平均速率是多少。
		- **令牌桶尽可能的稳定请求，请求消费不了就丢弃**，适合控制访问速率，避免偶然抖动。
- 分布式 ID
	- 要求
		- 高性能
		- 高可用
		- 有序递增
		- 接入简单
		- 安全，不包含敏感信息
	- 实现
		- Nosql 生成
		- UUID
		- 雪花算法等