#分布式 #数据库 #数据结构 

# 数据复制方式

![](https://varg-my-images.oss-cn-beijing.aliyuncs.com/img/20220610130604.png)

## 同步复制

## 基础同步复制

主节点将数据发送给从节点，待从节点 ack 以后主节点再返回客户端 ack 信号。对于复制给从节点的数据，可以等到全部从节点 ack，亦可以部分从节点 ack 即可，但是至少需要一个从节点 ack 才能保证数据已被复制。

同步复制可以保证至少有一个副本备份了数据，缺点是从节点的延迟会阻塞主节点的处理直到从节点 ack。

## 链式复制

## 异步复制

主节点将数据发送给从节点后不等待从节点 ack 即向客户端 ack，这样不能百分百保证数据被备份，但在某些要求高吞吐量的场景下此种方式被广泛使用，特别是那些从节点数量巨大或者分布千广域地理环境。

# 节点失效与切换

## 从节点失效

对于从节点失效，通常只需要等待节点重启后，从最后一次同步记录开始继续同步主节点数据即可。

## 主节点失效

主节点失效后，通常需要处理以下两个问题：主从切换，选择一个从节点将其提升为主节点；主节点切换，客户端需要往新主节点写入数据，其他从节点也要从新主节点同步数据。

主从切换可以手动切换或自动切换，自动切换步骤如下：

1. 确认主节点失效

	类似于系统崩溃，停电、网络问题等都会导致主节点失效，没有万无一失的方法可以检测问题如何产生，所以大多数系统都采用了基于超时的机制：节点间频繁地互相发生发送心跳存活消息，如果发现某一个节点在一段比较长时间内 (例如 30s) 没有响应，即认为该节点发生失效。

2. 选举新的主节点

	可以通过选举的方式 (超过多数的节点达成共识) 来选举新的主节点，或者由之前选定的某控制节点来指定新的主节点。候选节点最好与原主节点的数据差异最小，这样可以最小化数据丢失的风险。让所有节点同意新的主节点是个典型的共识问题。

3. 重新配置系统使新主节点生效

	客户端现在需要将写请求发送给新的主节点。如果原主节点之后重新上线，可能仍然自认为是主节点，而没有意识到其他节点已经达成共识迫使其下台。这时系统要确保原主节点降级为从节点，并认可新的主节点。