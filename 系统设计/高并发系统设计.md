
# 1. 系统设计原则

## 1.1. 系统通用设计方法

我们在应对高并发大流量时会采用类似水库抵御洪水的方案，归纳起来共有三种方法：

- Scale-up（纵向扩展）与 Scale-out（横向扩展）

	纵向扩展旨在增加机器配置达到应对请求流量的目的，然而随着硬件发展，摩尔定律已经失效，所以纵向扩展前期能收获一定成果，但有一定上限。

	横向扩展，分而治之是一种常见的高并发系统设计方法，采用分布式部署的方式把流量分流开，让每个服务器都承担一部分并发和流量。

	Scale-out 虽然能够突破单机的限制，但也会引入一些复杂问题。比如，如果某个节点出现故障如何保证整体可用性？当多个节点有状态需要同步时如何保证状态信息在不同节点的一致性？如何做到使用方无感知的增加和删除节点？其中每一个问题都涉及很多方面，因此需要仔细考虑。

- 缓存

	使用缓存来提高系统的性能，就好比用“蓄水池”的方式抵抗高并发大流量的冲击。

- 异步

	在某些场景下，未处理完成之前我们可以让请求先返回，在数据准备好之后再通知请求方，这样可以在单位时间内处理更多的请求。

## 1.2. 系统的分层架构

分层的好处：

- 分层的设计可以简化系统设计，让不同的人专注做某一层次的事情。

- 分层之后可以做到很高的复用。

- 分层架构可以让我们更容易做横向扩展。

任何的方案架构都是有优势有缺陷的，它最主要的一个缺陷就是增加了代码的复杂度，也可能会有性能的损耗，但是相比于它能带给我们的好处来说，这些都是可以接受的，或者可以通过其它的方案解决的。我们在做决策的时候切不可以偏概全，因噎废食。

## 1.3. 高并发系统设计思路

1. 高性能

	- 性能的度量指标：平均值、最大值、最小值、分位值等。

	- 性能的优化方式

		- 提升处理核心数，如进程数量，但需要注意测试进程数量与性能的关系，找到拐点。

		- 提升单次任务响应时间。

2. 高可用

	高可用要求提升系统的可用性，也就是我们常说的几个 9。

	系统设计方面：可以从故障恢复、超时控制、降级、限流几方面进行。

	系统运维方面：可以从灰度发布，故障演练两方面进行。

3. 高扩展

	- 存储层的扩展：数据库拆分

	- 业务层的扩展：按业务维度、重要维度、请求来源等进行拆分。

# 2. 系统设计方法

## 2.1. 数据库篇

### 2.1.1. 池化技术

我们所管理的某些对象，无论是连接还是线程，它们的创建过程都比较耗时，也比较消耗系统资源。所以，我们把它们放在一个池子里统一管理起来，以达到提升性能和资源复用的目的。

这是一种常见的软件设计思想，叫做**池化技术，它的核心思想是空间换时间，期望使用预先创建好的对象来减少频繁创建对象的性能开销**，同时还可以对对象进行统一的管理，降低了对象的使用的成本，总之是好处多多。

不过，池化技术也存在一些缺陷，比方说存储池子中的对象肯定需要消耗多余的内存，如果对象没有被频繁使用，就会造成内存上的浪费。再比方说，池子中的对象需要在系统启动的时候就预先创建完成，这在一定程度上增加了系统启动时间。可这些缺陷相比池化技术的优势来说就比较微不足道了，只要我们确认要使用的对象在创建时确实比较耗时或者消耗资源，并且这些对象也确实会被频繁地创建和销毁，我们就可以使用池化技术来优化。

使用池化技术时，需要注意以下几点：

- 池子的最大值和最小值的设置很重要，初期可以依据经验来设置，后面还是需要根据实际运行情况做调整。

- 池子中的对象需要在使用之前预先初始化完成，这叫做池子的预热，比方说使用线程池时就需要预先初始化所有的核心线程。如果池子未经过预热可能会导致系统重启后产生比较多的慢请求。

- 池化技术核心是一种空间换时间优化方法的实践，所以要关注空间占用情况，避免出现空间过度使用出现内存泄露或者频繁垃圾回收等问题。

### 数据复制与分区

对数据进行[[数据密集型系统设计2：复制与分区|复制与分区]]，保证数据的可用性及性能，对于数据库可以采用主从部署来实现数据复制，使用分库分表来实现分区的效果。



